import { API_URL } from '../api_config';
import React, { useState, useEffect } from 'react'; import { Card, CardHeader, CardTitle, CardContent } from './ui/card'; import { Button } from './ui/button'; import { Badge } from './ui/badge'; import { Input } from './ui/input'; import { Label } from './ui/label'; import { Textarea } from './ui/textarea'; import {   CheckCircle,   XCircle,   Eye,   Download,   AlertCircle,   Calculator,   Clock,   Search,   Filter } from 'lucide-react';  const ValidacaoPropostas = () => {   const [propostas, setPropostas] = useState([]);   const [loading, setLoading] = useState(true);   const [error, setError] = useState(null);   const [success, setSuccess] = useState(null);   const [selectedProposta, setSelectedProposta] = useState(null);   const [showValidationModal, setShowValidationModal] = useState(false);   const [validationForm, setValidationForm] = useState({     acao: '',     motivo: ''   });   const [searchTerm, setSearchTerm] = useState('');    const API_BASE = API_URL;    useEffect(() => {     fetchPropostas();   }, []);    const fetchPropostas = async () => {     try {       setLoading(true);       const token = sessionStorage.getItem('token');        if (!token) {         setError('Token de autenticação não encontrado');         return;       }        const response = await fetch(`${API_BASE}/gestor/propostas/?status=enviada`, {         headers: {           'Authorization': `Token ${token}`,           'Content-Type': 'application/json',           'Accept': 'application/json',           'X-Requested-With': 'XMLHttpRequest'         },         credentials: 'same-origin'       });        if (!response.ok) {         if (response.status === 403) {           throw new Error('Acesso negado. Verifique se você tem permissão de gestor.');         } else if (response.status === 401) {           throw new Error('Sessão expirada. Faça login novamente.');         } else {           throw new Error(`Erro ao buscar propostas: ${response.status}`);         }       }        const data = await response.json();       setPropostas(data);       setError(null);     } catch (err) {       setError(err.message);     } finally {       setLoading(false);     }   };     const openValidationModal = (proposta) => {     setSelectedProposta(proposta);     setValidationForm({       acao: '',       motivo: ''     });     setShowValidationModal(true);   };    const closeValidationModal = () => {     setShowValidationModal(false);     setSelectedProposta(null);     setValidationForm({       acao: '',       motivo: ''     });   };    const handleValidation = async () => {     if (!validationForm.acao) {       setError('Selecione uma ação: validar ou rejeitar');       return;     }      if (validationForm.acao === 'rejeitar' && !validationForm.motivo) {       setError('Informe o motivo da rejeição');       return;     }      try {       const token = sessionStorage.getItem('token');        if (!token) {         setError('Token de autenticação não encontrado');         return;       }        const requestData = {         acao: validationForm.acao,         motivo: validationForm.motivo       };        const response = await fetch(`${API_BASE}/gestor/propostas/${selectedProposta.id}/validar/`, {         method: 'PUT',         headers: {           'Authorization': `Token ${token}`,           'Content-Type': 'application/json',           'Accept': 'application/json',           'X-Requested-With': 'XMLHttpRequest'         },         credentials: 'same-origin',         body: JSON.stringify(requestData)       });        if (!response.ok) {         if (response.status === 403) {           throw new Error('Acesso negado. Verifique se você tem permissão de gestor.');         } else if (response.status === 401) {           throw new Error('Sessão expirada. Faça login novamente.');         } else {           throw new Error(`Erro ao processar validação: ${response.status}`);         }       }        const result = await response.json();        setSuccess(result.message);       setError(null);       closeValidationModal();       fetchPropostas(); // Atualizar lista        // Atualizar dashboard da banca após validação       setTimeout(() => {         // Disparar evento para atualizar dashboard da banca         window.dispatchEvent(new CustomEvent('proposalValidated', {           detail: { proposalId: selectedProposta.id, action: validationForm.acao }         }));          // Forçar recarregamento do dashboard da banca se estiver na página         if (window.location.pathname.includes('/banca')) {           window.location.reload();         }       }, 500);        // Limpar mensagem de sucesso após 3 segundos       setTimeout(() => setSuccess(null), 3000);     } catch (err) {       setError(err.message);       setSuccess(null);     }   };    const calcularPontosEstimados = () => {     if (!selectedProposta) return 0;      // Pegar regras simplificadas (idealmente viria da config da API)     const pontosPropostaValidada = 5;     const pontosPorProduto = 2;      let pontosBase = pontosPropostaValidada + (selectedProposta.quantidade_produtos * pontosPorProduto);      // Adicionar bônus baseados no que foi marcado     let pontosBonusTotal = 0;     if (selectedProposta.bonus_vinhos_casa_perini_mundo) pontosBonusTotal += 5;     if (selectedProposta.bonus_vinhos_fracao_unica) pontosBonusTotal += 5;     if (selectedProposta.bonus_espumantes_vintage) pontosBonusTotal += 5;     if (selectedProposta.bonus_espumantes_premium) pontosBonusTotal += 5;     if (selectedProposta.bonus_aceleracao) pontosBonusTotal += 25;      return pontosBase + pontosBonusTotal;   };    const filteredPropostas = propostas.filter(proposta =>     proposta.cliente_nome?.toLowerCase().includes(searchTerm.toLowerCase()) ||     proposta.equipe_nome?.toLowerCase().includes(searchTerm.toLowerCase()) ||     proposta.id.toString().includes(searchTerm)   );    if (loading) {     return (       <div className="flex items-center justify-center p-8">         <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"></div>         <span className="ml-2">Carregando propostas...</span>       </div>     );   }    return (     <div className="space-y-6">       {/* Header */}       <div className="flex items-center justify-between">         <div className="flex items-center gap-2">           <CheckCircle className="h-6 w-6 text-orange-600" />           <h2 className="text-2xl font-bold text-gray-900">Validação de Propostas</h2>           <Badge variant="outline" className="bg-orange-50 text-orange-700 border-orange-200">             Gestor           </Badge>         </div>         <div className="flex items-center gap-2">           <div className="relative">             <Search className="h-4 w-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />             <Input               placeholder="Buscar propostas..."               value={searchTerm}               onChange={(e) => setSearchTerm(e.target.value)}               className="pl-10 w-64"             />           </div>         </div>       </div>        {/* Alertas */}       {error && (         <div className="flex items-center gap-2 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">           <AlertCircle className="h-4 w-4" />           <span>{error}</span>         </div>       )}        {success && (         <div className="flex items-center gap-2 p-4 bg-green-50 border border-green-200 rounded-lg text-green-700">           <CheckCircle className="h-4 w-4" />           <span>{success}</span>         </div>       )}        {/* Lista de Propostas */}       {filteredPropostas.length === 0 ? (         <Card>           <CardContent className="text-center py-8">             <Clock className="h-12 w-12 mx-auto mb-4 text-gray-400" />             <h3 className="text-lg font-semibold text-gray-700 mb-2">               {searchTerm ? 'Nenhuma proposta encontrada' : 'Nenhuma proposta aguardando validação'}             </h3>             <p className="text-gray-500">               {searchTerm ? 'Tente outros termos de busca' : 'Todas as propostas já foram processadas'}             </p>           </CardContent>         </Card>       ) : (         <div className="space-y-4">           {filteredPropostas.map((proposta) => (             <Card key={proposta.id} className="hover:shadow-md transition-shadow">               <CardContent className="p-6">                 <div className="flex items-start justify-between">                   <div className="flex-1">                     <div className="flex items-center gap-2 mb-3">                       <h3 className="text-lg font-semibold">{proposta.equipe_nome} – Proposta {proposta.numero_proposta_equipe || proposta.id}</h3>                       <Badge className="bg-blue-100 text-blue-800">                         <Clock className="h-3 w-3 mr-1" />                         Aguardando Validação                       </Badge>                       <Badge variant="outline">                         {proposta.equipe_nome}                       </Badge>                     </div>                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600 mb-3">                       <div>                         <span className="font-medium">Cliente:</span> {proposta.cliente_nome}                       </div>                       <div>                         <span className="font-medium">Vendedor:</span> {proposta.vendedor_nome}                       </div>                       <div>                         <span className="font-medium">Valor:</span> R$ {parseFloat(proposta.valor_proposta).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}                       </div>                       <div>                         <span className="font-medium">Produtos:</span> {proposta.quantidade_produtos}                       </div>                     </div>                      {proposta.descricao && (                       <div className="mb-3 text-sm">                         <span className="font-medium">Descrição:</span> {proposta.descricao}                       </div>                     )}                      <div className="text-xs text-gray-500">                       Enviada em: {new Date(proposta.data_envio).toLocaleDateString('pt-BR')}                     </div>                   </div>                    <div className="flex gap-2 ml-4">                     {proposta.arquivo_pdf && (                       <Button                         variant="outline"                         size="sm"                         onClick={() => window.open(`${API_BASE}${proposta.arquivo_pdf}`, '_blank')}                       >                         <Eye className="h-4 w-4 mr-1" />                         Visualizar                       </Button>                     )}                     <Button                       onClick={() => openValidationModal(proposta)}                       className="bg-orange-600 hover:bg-orange-700 text-white"                     >                       <CheckCircle className="h-4 w-4 mr-1" />                       Validar                     </Button>                   </div>                 </div>               </CardContent>             </Card>           ))}         </div>       )}        {/* Modal de Validação */}       {showValidationModal && selectedProposta && (         <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">           <div className="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">             <div className="p-6">               <div className="flex items-center justify-between mb-4">                 <h3 className="text-xl font-bold">Validar Proposta {selectedProposta.equipe_nome} – Proposta {selectedProposta.numero_proposta_equipe || selectedProposta.id}</h3>                 <Button variant="outline" size="sm" onClick={closeValidationModal}>                   <XCircle className="h-4 w-4" />                 </Button>               </div>                {/* Informações da Proposta */}               <div className="bg-gray-50 p-4 rounded-lg mb-4">                 <h4 className="font-semibold mb-2">Informações da Proposta</h4>                 <div className="grid grid-cols-2 gap-2 text-sm">                   <div><span className="font-medium">Equipe:</span> {selectedProposta.equipe_nome}</div>                   <div><span className="font-medium">Cliente:</span> {selectedProposta.cliente_nome}</div>                   <div><span className="font-medium">Valor:</span> R$ {parseFloat(selectedProposta.valor_proposta).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>                   <div><span className="font-medium">Produtos:</span> {selectedProposta.quantidade_produtos}</div>                 </div>                  {/* Visualização dos Bônus Selecionados */}                 {(selectedProposta.bonus_vinhos_casa_perini_mundo ||                   selectedProposta.bonus_vinhos_fracao_unica ||                   selectedProposta.bonus_espumantes_vintage ||                   selectedProposta.bonus_espumantes_premium ||                   selectedProposta.bonus_aceleracao) && (                     <div className="mt-3 pt-3 border-t border-gray-200">                       <span className="font-medium text-sm block mb-2">Bônus Selecionados pela Equipe:</span>                       <div className="flex flex-wrap gap-2">                         {selectedProposta.bonus_vinhos_casa_perini_mundo && (                           <Badge className="bg-orange-100 text-orange-800 border-orange-200">Perini Mundo (+5)</Badge>                         )}                         {selectedProposta.bonus_vinhos_fracao_unica && (                           <Badge className="bg-orange-100 text-orange-800 border-orange-200">Fração Única (+5)</Badge>                         )}                         {selectedProposta.bonus_espumantes_vintage && (                           <Badge className="bg-orange-100 text-orange-800 border-orange-200">Esp. Vintage (+5)</Badge>                         )}                         {selectedProposta.bonus_espumantes_premium && (                           <Badge className="bg-orange-100 text-orange-800 border-orange-200">Esp. Premium (+5)</Badge>                         )}                         {selectedProposta.bonus_aceleracao && (                           <Badge className="bg-red-100 text-red-800 border-red-200 font-bold">ACELERAÇÃO (+25)</Badge>                         )}                       </div>                     </div>                   )}               </div>                {/* Cálculo de Pontos */}               <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">                 <h4 className="font-semibold mb-2 flex items-center gap-2">                   <Calculator className="h-4 w-4 text-blue-600" />                   Cálculo de Pontos                 </h4>                 <div className="text-sm space-y-1">                   <div>Base: 5 pts + ({selectedProposta.quantidade_produtos} × 2 pts) = {5 + (selectedProposta.quantidade_produtos * 2)} pts</div>                    {/* Detalhamento dos Bônus no Cálculo */}                   {(selectedProposta.bonus_vinhos_casa_perini_mundo ||                     selectedProposta.bonus_vinhos_fracao_unica ||                     selectedProposta.bonus_espumantes_vintage ||                     selectedProposta.bonus_espumantes_premium ||                     selectedProposta.bonus_aceleracao) && (                       <div className="text-orange-600">                         Bônus: +{                           (selectedProposta.bonus_vinhos_casa_perini_mundo ? 5 : 0) +                           (selectedProposta.bonus_vinhos_fracao_unica ? 5 : 0) +                           (selectedProposta.bonus_espumantes_vintage ? 5 : 0) +                           (selectedProposta.bonus_espumantes_premium ? 5 : 0) +                           (selectedProposta.bonus_aceleracao ? 25 : 0)                         } pts                       </div>                     )}                    <div className="font-bold text-blue-700 pt-2 border-t mt-2">                     Total Estimado: {calcularPontosEstimados()} pontos                   </div>                 </div>               </div>                {/* Formulário de Validação */}               <div className="space-y-4">                 <div>                   <Label>Ação</Label>                   <div className="flex gap-4 mt-2">                     <Button                       variant={validationForm.acao === 'validar' ? 'default' : 'outline'}                       onClick={() => setValidationForm({ ...validationForm, acao: 'validar' })}                       className={validationForm.acao === 'validar' ? 'bg-green-600 hover:bg-green-700' : ''}                     >                       <CheckCircle className="h-4 w-4 mr-2" />                       Validar Proposta                     </Button>                     <Button                       variant={validationForm.acao === 'rejeitar' ? 'default' : 'outline'}                       onClick={() => setValidationForm({ ...validationForm, acao: 'rejeitar' })}                       className={validationForm.acao === 'rejeitar' ? 'bg-red-600 hover:bg-red-700' : ''}                     >                       <XCircle className="h-4 w-4 mr-2" />                       Rejeitar Proposta                     </Button>                   </div>                 </div>                  {validationForm.acao === 'rejeitar' && (                   <div>                     <Label htmlFor="motivo">Motivo da Rejeição *</Label>                     <Textarea                       id="motivo"                       value={validationForm.motivo}                       onChange={(e) => setValidationForm({ ...validationForm, motivo: e.target.value })}                       placeholder="Descreva o motivo da rejeição..."                       rows={3}                       className="mt-2"                     />                   </div>                 )}                  <div className="flex justify-end gap-4 pt-4 border-t">                   <Button variant="outline" onClick={closeValidationModal}>                     Cancelar                   </Button>                   <Button                     onClick={handleValidation}                     disabled={!validationForm.acao || (validationForm.acao === 'rejeitar' && !validationForm.motivo)}                     className={validationForm.acao === 'validar' ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}                   >                     {validationForm.acao === 'validar' ? (                       <>                         <CheckCircle className="h-4 w-4 mr-2" />                         Validar Proposta                       </>                     ) : (                       <>                         <XCircle className="h-4 w-4 mr-2" />                         Rejeitar Proposta                       </>                     )}                   </Button>                 </div>               </div>             </div>           </div>         </div>       )}     </div>   ); };  export default ValidacaoPropostas;


