import { API_URL } from '../api_config';
import React, { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from './ui/card';
import { Button } from './ui/button';
import { Badge } from './ui/badge';
import { Input } from './ui/input';
import { Label } from './ui/label';
import { Textarea } from './ui/textarea';
import { CheckCircle, XCircle, Eye, Calculator, Clock, Search, AlertCircle } from 'lucide-react';
import '../styles/ValidarVendas.css';
import '../styles/ValidacaoPropostas.css';

const ValidacaoPropostas = () => {   const [propostas, setPropostas] = useState([]);   const [loading, setLoading] = useState(true);   const [error, setError] = useState(null);   const [success, setSuccess] = useState(null);   const [selectedProposta, setSelectedProposta] = useState(null);   const [showValidationModal, setShowValidationModal] = useState(false);   const [validationForm, setValidationForm] = useState({     acao: '',     motivo: ''   });   const [searchTerm, setSearchTerm] = useState('');    const API_BASE = API_URL;    useEffect(() => {     fetchPropostas();   }, []);    const fetchPropostas = async () => {     try {       setLoading(true);       const token = sessionStorage.getItem('token');        if (!token) {         setError('Token de autenticação não encontrado');         return;       }        const response = await fetch(`${API_BASE}/api/gestor/propostas/?status=enviada`, {         headers: {           'Authorization': `Token ${token}`,           'Content-Type': 'application/json',           'Accept': 'application/json',           'X-Requested-With': 'XMLHttpRequest'         },         credentials: 'same-origin'       });        if (!response.ok) {         if (response.status === 403) {           throw new Error('Acesso negado. Verifique se você tem permissão de gestor.');         } else if (response.status === 401) {           throw new Error('Sessão expirada. Faça login novamente.');         } else {           throw new Error(`Erro ao buscar propostas: ${response.status}`);         }       }        const data = await response.json();       setPropostas(data);       setError(null);     } catch (err) {       setError(err.message);     } finally {       setLoading(false);     }   };     const openValidationModal = (proposta, acaoInicial = '') => {     setSelectedProposta(proposta);     setValidationForm({       acao: acaoInicial,       motivo: ''     });     setShowValidationModal(true);   };    const closeValidationModal = () => {     setShowValidationModal(false);     setSelectedProposta(null);     setValidationForm({       acao: '',       motivo: ''     });   };    const handleValidation = async () => {     if (!validationForm.acao) {       setError('Selecione uma ação: validar ou rejeitar');       return;     }      if (validationForm.acao === 'rejeitar' && !validationForm.motivo) {       setError('Informe o motivo da rejeição');       return;     }      try {       const token = sessionStorage.getItem('token');        if (!token) {         setError('Token de autenticação não encontrado');         return;       }        const requestData = {         acao: validationForm.acao,         motivo: validationForm.motivo       };        const response = await fetch(`${API_BASE}/api/gestor/propostas/${selectedProposta.id}/validar/`, {         method: 'PUT',         headers: {           'Authorization': `Token ${token}`,           'Content-Type': 'application/json',           'Accept': 'application/json',           'X-Requested-With': 'XMLHttpRequest'         },         credentials: 'same-origin',         body: JSON.stringify(requestData)       });        if (!response.ok) {         if (response.status === 403) {           throw new Error('Acesso negado. Verifique se você tem permissão de gestor.');         } else if (response.status === 401) {           throw new Error('Sessão expirada. Faça login novamente.');         } else {           throw new Error(`Erro ao processar validação: ${response.status}`);         }       }        const result = await response.json();        setSuccess(result.message);       setError(null);       closeValidationModal();       fetchPropostas(); // Atualizar lista        // Atualizar dashboard da banca após validação       setTimeout(() => {         // Disparar evento para atualizar dashboard da banca         window.dispatchEvent(new CustomEvent('proposalValidated', {           detail: { proposalId: selectedProposta.id, action: validationForm.acao }         }));          // Forçar recarregamento do dashboard da banca se estiver na página         if (window.location.pathname.includes('/banca')) {           window.location.reload();         }       }, 500);        // Limpar mensagem de sucesso após 3 segundos       setTimeout(() => setSuccess(null), 3000);     } catch (err) {       setError(err.message);       setSuccess(null);     }   };    const calcularPontosEstimados = () => {     if (!selectedProposta) return 0;      // Pegar regras simplificadas (idealmente viria da config da API)     const pontosPropostaValidada = 5;     const pontosPorProduto = 2;      let pontosBase = pontosPropostaValidada + (selectedProposta.quantidade_produtos * pontosPorProduto);      // Adicionar bônus baseados no que foi marcado     let pontosBonusTotal = 0;     if (selectedProposta.bonus_vinhos_casa_perini_mundo) pontosBonusTotal += 5;     if (selectedProposta.bonus_vinhos_fracao_unica) pontosBonusTotal += 5;     if (selectedProposta.bonus_espumantes_vintage) pontosBonusTotal += 5;     if (selectedProposta.bonus_espumantes_premium) pontosBonusTotal += 5;     if (selectedProposta.bonus_aceleracao) pontosBonusTotal += 25;      return pontosBase + pontosBonusTotal;   };    const filteredPropostas = propostas.filter(proposta =>     proposta.cliente_nome?.toLowerCase().includes(searchTerm.toLowerCase()) ||     proposta.equipe_nome?.toLowerCase().includes(searchTerm.toLowerCase()) ||     proposta.id.toString().includes(searchTerm)   );    if (loading) {     return (       <div className="flex items-center justify-center p-8">         <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-orange-600"></div>         <span className="ml-2">Carregando propostas...</span>       </div>     );   }    return (     <div className="validacao-propostas-wrap space-y-6">       <div className="flex items-center justify-between flex-wrap gap-4">         <div className="flex items-center gap-2">           <CheckCircle className="h-6 w-6" style={{ color: '#FF5E3A' }} />           <h2 className="text-2xl font-bold" style={{ color: '#1a3a41' }}>Propostas Aguardando Validação</h2>         </div>         <div className="relative">           <Search className="h-4 w-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />           <Input               placeholder="Buscar propostas..."               value={searchTerm}               onChange={(e) => setSearchTerm(e.target.value)}               className="pl-10 w-64"             />         </div>       </div>        {error && (         <div className="alert error">           <AlertCircle className="h-4 w-4" />           <span>{error}</span>         </div>       )}        {success && (         <div className="alert success">           <CheckCircle className="h-4 w-4" />           <span>{success}</span>         </div>       )}        {filteredPropostas.length === 0 ? (         <div className="validacao-proposta-card" style={{ textAlign: 'center', padding: '3rem' }}>           <Clock className="h-12 w-12 mx-auto mb-4" style={{ color: '#94a3b8' }} />           <h3 className="text-lg font-semibold mb-2" style={{ color: '#475569' }}>             {searchTerm ? 'Nenhuma proposta encontrada' : 'Nenhuma proposta aguardando validação'}           </h3>           <p style={{ color: '#94a3b8' }}>             {searchTerm ? 'Tente outros termos de busca' : 'Todas as propostas já foram processadas'}           </p>         </div>       ) : (         <div className="vendas-list">           {filteredPropostas.map((proposta) => (             <div key={proposta.id} className="validacao-proposta-card">               <div className="validacao-card-header">                 <h3 className="validacao-card-title">                   {proposta.equipe_nome} – Proposta {proposta.numero_proposta_equipe || proposta.id} – {proposta.cliente_nome}                 </h3>                 <span className="validacao-status-badge">                   <Clock className="h-4 w-4" />                   Aguardando Validação                 </span>               </div>               <div className="validacao-card-details">                 <p className="text-xs text-gray-500 mb-4">                   Registrado em {new Date(proposta.data_envio || proposta.created_at || proposta.data_criacao || new Date()).toLocaleString('pt-BR')}                 </p>                 <div className="validacao-detail-grid">                   <div className="validacao-detail-item">                     <label>Cliente / Empresa</label>                     <span>{proposta.cliente_nome}</span>                   </div>                   <div className="validacao-detail-item">                     <label>Valor Estimado</label>                     <span className="validacao-valor-proposta">R$ {parseFloat(proposta.valor_proposta).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>                   </div>                   <div className="validacao-detail-item">                     <label>Produtos</label>                     <span>{proposta.quantidade_produtos} Produtos</span>                   </div>                   <div className="validacao-detail-item">                     <label>Consultor</label>                     <span>{proposta.vendedor_nome}</span>                   </div>                   {proposta.descricao && (                     <div className="validacao-detail-item" style={{ gridColumn: '1 / -1' }}>                       <label>Resumo e Detalhamento</label>                       <span>{proposta.descricao}</span>                     </div>                   )}                 </div>               </div>               <div className="validacao-card-actions">                 {proposta.arquivo_pdf && (                   <Button variant="outline" size="sm" onClick={() => window.open(proposta.arquivo_pdf?.startsWith('http') ? proposta.arquivo_pdf : `${API_BASE}${proposta.arquivo_pdf}`, '_blank')}>                     <Eye className="h-4 w-4 mr-2" />                     PDF Comercial                   </Button>                 )}                 <Button onClick={() => openValidationModal(proposta, 'validar')} className="btn-validar-proposta">                   <CheckCircle className="h-4 w-4" />                   Validar Proposta                 </Button>                 <Button variant="outline" onClick={() => openValidationModal(proposta, 'rejeitar')} className="btn-rejeitar-proposta">                   <XCircle className="h-4 w-4" />                   Rejeitar Proposta                 </Button>               </div>             </div>           ))}         </div>       )}        {/* Modal de Validação */}       {showValidationModal && selectedProposta && (         <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">           <div className="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">             <div className="p-6">               <div className="flex items-center justify-between mb-4">                 <h3 className="text-xl font-bold">Validar Proposta {selectedProposta.equipe_nome} – Proposta {selectedProposta.numero_proposta_equipe || selectedProposta.id}</h3>                 <Button variant="outline" size="sm" onClick={closeValidationModal}>                   <XCircle className="h-4 w-4" />                 </Button>               </div>                {/* Informações da Proposta */}               <div className="bg-gray-50 p-4 rounded-lg mb-4">                 <h4 className="font-semibold mb-2">Informações da Proposta</h4>                 <div className="grid grid-cols-2 gap-2 text-sm">                   <div><span className="font-medium">Equipe:</span> {selectedProposta.equipe_nome}</div>                   <div><span className="font-medium">Cliente:</span> {selectedProposta.cliente_nome}</div>                   <div><span className="font-medium">Valor:</span> R$ {parseFloat(selectedProposta.valor_proposta).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>                   <div><span className="font-medium">Produtos:</span> {selectedProposta.quantidade_produtos}</div>                 </div>                  {/* Visualização dos Bônus Selecionados */}                 {(selectedProposta.bonus_vinhos_casa_perini_mundo ||                   selectedProposta.bonus_vinhos_fracao_unica ||                   selectedProposta.bonus_espumantes_vintage ||                   selectedProposta.bonus_espumantes_premium ||                   selectedProposta.bonus_aceleracao) && (                     <div className="mt-3 pt-3 border-t border-gray-200">                       <span className="font-medium text-sm block mb-2">Bônus Selecionados pela Equipe:</span>                       <div className="flex flex-wrap gap-2">                         {selectedProposta.bonus_vinhos_casa_perini_mundo && (                           <Badge className="bg-orange-100 text-orange-800 border-orange-200">Perini Mundo (+5)</Badge>                         )}                         {selectedProposta.bonus_vinhos_fracao_unica && (                           <Badge className="bg-orange-100 text-orange-800 border-orange-200">Fração Única (+5)</Badge>                         )}                         {selectedProposta.bonus_espumantes_vintage && (                           <Badge className="bg-orange-100 text-orange-800 border-orange-200">Esp. Vintage (+5)</Badge>                         )}                         {selectedProposta.bonus_espumantes_premium && (                           <Badge className="bg-orange-100 text-orange-800 border-orange-200">Esp. Premium (+5)</Badge>                         )}                         {selectedProposta.bonus_aceleracao && (                           <Badge className="bg-red-100 text-red-800 border-red-200 font-bold">ACELERAÇÃO (+25)</Badge>                         )}                       </div>                     </div>                   )}               </div>                {/* Cálculo de Pontos */}               <div className="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">                 <h4 className="font-semibold mb-2 flex items-center gap-2">                   <Calculator className="h-4 w-4 text-blue-600" />                   Cálculo de Pontos                 </h4>                 <div className="text-sm space-y-1">                   <div>Base: 5 pts + ({selectedProposta.quantidade_produtos} × 2 pts) = {5 + (selectedProposta.quantidade_produtos * 2)} pts</div>                    {/* Detalhamento dos Bônus no Cálculo */}                   {(selectedProposta.bonus_vinhos_casa_perini_mundo ||                     selectedProposta.bonus_vinhos_fracao_unica ||                     selectedProposta.bonus_espumantes_vintage ||                     selectedProposta.bonus_espumantes_premium ||                     selectedProposta.bonus_aceleracao) && (                       <div className="text-orange-600">                         Bônus: +{                           (selectedProposta.bonus_vinhos_casa_perini_mundo ? 5 : 0) +                           (selectedProposta.bonus_vinhos_fracao_unica ? 5 : 0) +                           (selectedProposta.bonus_espumantes_vintage ? 5 : 0) +                           (selectedProposta.bonus_espumantes_premium ? 5 : 0) +                           (selectedProposta.bonus_aceleracao ? 25 : 0)                         } pts                       </div>                     )}                    <div className="font-bold text-blue-700 pt-2 border-t mt-2">                     Total Estimado: {calcularPontosEstimados()} pontos                   </div>                 </div>               </div>                {/* Formulário de Validação */}               <div className="space-y-4">                 <div>                   <Label>Ação</Label>                   <div className="flex gap-4 mt-2">                     <Button                       variant={validationForm.acao === 'validar' ? 'default' : 'outline'}                       onClick={() => setValidationForm({ ...validationForm, acao: 'validar' })}                       className={validationForm.acao === 'validar' ? 'bg-green-600 hover:bg-green-700' : ''}                     >                       <CheckCircle className="h-4 w-4 mr-2" />                       Validar Proposta                     </Button>                     <Button                       variant={validationForm.acao === 'rejeitar' ? 'default' : 'outline'}                       onClick={() => setValidationForm({ ...validationForm, acao: 'rejeitar' })}                       className={validationForm.acao === 'rejeitar' ? 'bg-red-600 hover:bg-red-700' : ''}                     >                       <XCircle className="h-4 w-4 mr-2" />                       Rejeitar Proposta                     </Button>                   </div>                 </div>                  {validationForm.acao === 'rejeitar' && (                   <div>                     <Label htmlFor="motivo">Motivo da Rejeição *</Label>                     <Textarea                       id="motivo"                       value={validationForm.motivo}                       onChange={(e) => setValidationForm({ ...validationForm, motivo: e.target.value })}                       placeholder="Descreva o motivo da rejeição..."                       rows={3}                       className="mt-2"                     />                   </div>                 )}                  <div className="flex justify-end gap-4 pt-4 border-t">                   <Button variant="outline" onClick={closeValidationModal}>                     Cancelar                   </Button>                   <Button                     onClick={handleValidation}                     disabled={!validationForm.acao || (validationForm.acao === 'rejeitar' && !validationForm.motivo)}                     className={validationForm.acao === 'validar' ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'}                   >                     {validationForm.acao === 'validar' ? (                       <>                         <CheckCircle className="h-4 w-4 mr-2" />                         Validar Proposta                       </>                     ) : (                       <>                         <XCircle className="h-4 w-4 mr-2" />                         Rejeitar Proposta                       </>                     )}                   </Button>                 </div>               </div>             </div>           </div>         </div>       )}     </div>   ); };  export default ValidacaoPropostas;


